# libc/mcs51 Makefile

VPATH  = @srcdir@
srcdir = @srcdir@

top_srcdir   = @top_srcdir@
top_builddir = @top_builddir@

LIB_TYPE     = @LIB_TYPE@
SAS = $(top_builddir)/bin/i51-elf-as
SCC = $(top_builddir)/bin/sdcc
SDAR = $(top_builddir)/bin/i51-elf-ar

# override PORTDIR defined by super (parent) makefile
override PORTDIR = ../build/$(PORT)

OBJ = crtstart.o \
      crtbank.o crtcall.o \
      gptr_cmp.o \
      atomic_flag_test_and_set.o atomic_flag_clear.o __sdcc_atomic_maybe_rollback.o

LIB = libmcs51.a

CC = $(SCC)
AS = $(SAS)
ASFLAGS = -mmcs51

CFLAGS = -I$(top_srcdir)/device/include --std-c23

all: $(PORTDIR)/$(LIB)

$(PORTDIR)/$(LIB): $(OBJ) Makefile
ifeq ($(LIB_TYPE), SDCCLIB)
	rm -f $@; \
	$(top_builddir)/bin/sdcclib -a $@ $(OBJ)
else
  ifeq ($(LIB_TYPE), AR)
	$(SDAR) -rcv $@ $(OBJ)
  else
    ifeq ($(LIB_TYPE), RANLIB)
	$(SDAR) -rcv $@ $(OBJ)
    else
	rm -f $@
	for i in $(basename $(OBJ)); do echo $$i >>$@; done
	cp $(OBJ) $(PORTDIR)
    endif
  endif
endif

%.o: %.c
	$(CC) $(CFLAGS) -c $<

%.o: %.asm
	@# TODO: asx8051 should place it\'s output in the current dir
	test $(srcdir) = . || cp $< .
	-$(AS) $(ASFLAGS) -al=$@.lst -o $@ $(notdir $<)
	test $(srcdir) = . || rm $(notdir $<)

clean:
	rm -f *.o *.sym *.lst *~ $(CLEANSPEC) *.dump* *.lib

distclean: clean
	rm -r Makefile

Makefile: $(srcdir)/Makefile.in
	cd $(top_builddir); ./config.status device/lib/mcs51/Makefile
